<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Builder.io Pages to CSV</title>
    <style>
      .builder-csv-btn {
        height: auto;
        width: auto;
        border-radius: 9999px;
        background-color: rgb(48 48 48);
        padding: 0.75rem 1.5rem;
        color: white;
        font-size: 1rem;
        border: none;
        cursor: pointer;
        transition: opacity 100ms ease-in;
      }
      .builder-csv-btn:hover {
        opacity: 0.9;
      }
      .builder-csv-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      pre {
        white-space: pre-wrap;
        margin-top: 1em;
      }
      .builder-csv-hidden {
        display: none;
      }

      .hidden {
        width: 0;
        height: 0;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <h1>Download Builder.io Pages as CSV</h1>
    <button class="builder-csv-btn" onclick="downloadPages()">
      Download CSV
    </button>
    <pre id="status" class="builder-csv-hidden"></pre>
    <p class="hidden">v6</p>

    <script>
      const API_KEY = "da92e0c53398459689b527346fc360a5";
      const MODEL = "page";
      const BASE_URL = "https://berlin-recycling.de"; // Replace with your actual domain

      function showStatus(message) {
        const status = document.getElementById("status");
        status.textContent = message;
        status.classList.remove("builder-csv-hidden");
      }

      function hideStatus() {
        const status = document.getElementById("status");
        status.classList.add("builder-csv-hidden");
      }

      function stripHtml(html) {
        // 1. Remove all tags like <p>, <br/>, <div>, etc.
        const withoutTags = html.replace(/<[^>]*>/g, "");

        // 2. Replace common HTML entities manually
        const decoded = withoutTags
          .replace(/&nbsp;/g, " ")
          .replace(/&amp;/g, "&")
          .replace(/&quot;/g, '"')
          .replace(/&#039;/g, "'")
          .replace(/&lt;/g, "<")
          .replace(/&gt;/g, ">")
          .replace(/&ouml;/g, "ö")
          .replace(/&auml;/g, "ä")
          .replace(/&uuml;/g, "ü")
          .replace(/&szlig;/g, "ß");

        return decoded.trim();
      }

      async function getAllBuilderContentUrls(model) {
        try {
          const allResults = [];
          let offset = 0;
          let hasMore = true;
          const PAGE_LIMIT = 50;

          while (hasMore) {
            let BASE_URL_API = `https://cdn.builder.io/api/v2/content/${model}?apiKey=${API_KEY}&limit=${PAGE_LIMIT}&offset=${offset}`;

            const res = await fetch(BASE_URL_API);

            if (!res.ok) {
              console.error(`Builder.io API error (${model}):`, res.statusText);
              break;
            }

            const data = await res.json();
            const results = data.results || [];

            allResults.push(...results);
            offset += PAGE_LIMIT;
            hasMore = results.length === PAGE_LIMIT;
          }

          return allResults
            .filter((item) => {
              const slug = item.data?.slug;
              const category = item.data?.category;
              if (!slug) return false;
              if (model === "job-details" && slug === "details") return false;
              if (model === "blog-posts" && !category) return false;
              return true;
            })
            .map((item) => {
              const slug = item.data?.slug;
              let fullUrl = "";

              if (model === "blog-posts") {
                fullUrl = `${BASE_URL}/blog${slug}`;
              } else if (model === "job-details") {
                fullUrl = `${BASE_URL}/jobs/${slug}`;
              } else if (model === "materials") {
                fullUrl = `${BASE_URL}/entsorgung/abfall-abc/${slug}`;
              } else if (model === "abfallschlussel-avv-model") {
                fullUrl = `${BASE_URL}/wissen/avv/${slug}`;
              } else {
                fullUrl = `${BASE_URL}/${slug}`;
              }

              const publish = item.data?.publish;

              let title;
              let description;

              if (model === "materials") {
                title = item?.data.name;
                description =
                  stripHtml(item?.data.shortDescription) ||
                  stripHtml(item?.data.seoDescription);
              } else {
                title = item?.data.title;
                description = item.data?.description;
              }

              return {
                id: item.id || "",
                title: title,
                description: description || "",
                name: slug,
                url: fullUrl,
                keywords: item.data?.keywords || "",
                noIndex: item.data?.noIndex || false,
                searchTitle: item.data?.searchTitle || "",
                responsiblePersonName: "",
                createdDate:
                  item.createdDate ?? item.createdAt
                    ? new Date(
                        String(item.createdDate ?? item.createdAt).length === 10
                          ? Number(item.createdDate ?? item.createdAt) * 1000
                          : Number(item.createdDate ?? item.createdAt)
                      )
                        .toISOString()
                        .slice(0, 10)
                    : "",
                lastUpdated:
                  item.lastUpdated ?? item.updatedAt
                    ? new Date(
                        String(item.lastUpdated ?? item.updatedAt).length === 10
                          ? Number(item.lastUpdated ?? item.updatedAt) * 1000
                          : Number(item.lastUpdated ?? item.updatedAt)
                      )
                        .toISOString()
                        .slice(0, 10)
                    : "",
                published: item.published,
                type: `Content Model ${model}`,
                builderLink: `https://builder.io/content/${item.id}/edit?activeDesignerTab=3&activeLocale=Default`,
                lastModified: publish
                  ? new Date(publish).toISOString().slice(0, 10)
                  : new Date().toISOString().slice(0, 10),
                changeFrequency: "daily",
                priority: 0.7,
                contentType: model,
              };
            });
        } catch (error) {
          console.error(
            `Failed to fetch Builder.io content (${model}):`,
            error
          );
          return [];
        }
      }

      async function fetchAllPages() {
        const allPages = [];
        let offset = 0;
        const limit = 100;
        let hasMore = true;

        while (hasMore) {
          const url = `https://cdn.builder.io/api/v2/content/${MODEL}?apiKey=${API_KEY}&limit=${limit}&offset=${offset}&query.published.%24ne=archived&query.priority.%24exists=true`;
          const res = await fetch(url);
          if (!res.ok) throw new Error(`Failed to fetch: ${res.statusText}`);

          const data = await res.json();
          allPages.push(...data.results);

          if (data.results.length < limit) {
            hasMore = false;
          } else {
            offset += limit;
          }
        }

        return allPages;
      }

      async function fetchReference(model, id) {
        const url = `https://cdn.builder.io/api/v2/content/${model}?apiKey=${API_KEY}&query.id=${id}`;
        const res = await fetch(url);
        if (!res.ok)
          throw new Error(`Failed to fetch reference: ${res.statusText}`);
        const data = await res.json();
        return data.results?.[0]?.data ?? null;
      }

      async function resolveResponsiblePersons(pages) {
        const uniquePersonIds = new Set();
        const personCache = new Map();

        // Collect all unique responsible person IDs
        for (const page of pages) {
          const responsiblePersonId = page.data?.responsiblePerson?.id;
          if (responsiblePersonId && typeof responsiblePersonId === "string") {
            uniquePersonIds.add(responsiblePersonId);
          }
        }

        showStatus(
          `Fetching ${uniquePersonIds.size} responsible person references...`
        );

        // Fetch all unique persons
        const fetchPromises = Array.from(uniquePersonIds).map(
          async (personId) => {
            if (!personId) return;

            try {
              const personData = await fetchReference(
                "responsible-person",
                personId
              );
              personCache.set(personId, personData?.name || "Unknown");
            } catch (err) {
              console.warn(`Failed to fetch person ${personId}:`, err);
              personCache.set(personId, "Unknown");
            }
          }
        );

        await Promise.all(fetchPromises);

        // Add resolved names to pages
        for (const page of pages) {
          const responsiblePersonId = page.data?.responsiblePerson?.id;
          if (responsiblePersonId && personCache.has(responsiblePersonId)) {
            page.responsiblePersonName = personCache.get(responsiblePersonId);
          } else {
            page.responsiblePersonName = "";
          }

          page.type = "Page";
        }

        return pages;
      }

      function convertToCSV(data) {
        const fields = [
          "id",
          "title",
          "description",
          "name",
          "url",
          "keywords",
          "noIndex",
          "searchTitle",
          "responsiblePersonName",
          "type",
          "published",
          "builderLink",
          "createdDate",
          "lastUpdated",
        ];
        const rows = [fields.join(",")];

        for (const item of data) {
          const row = fields
            .map((field) => {
              let value;
              if (field === "responsiblePersonName") {
                value = item.responsiblePersonName ?? "";
              } else if (field === "builderLink") {
                value = `https://builder.io/content/${item.id}/edit?activeDesignerTab=3&activeLocale=Default`;
              } else {
                value = item[field] ?? item.data?.[field] ?? "";
              }
              if (
                (field === "createdDate" || field === "lastUpdated") &&
                value !== "" &&
                (typeof value === "number" ||
                  /^(\d{10}|\d{13})$/.test(String(value)))
              ) {
                const numeric = Number(value);
                const millis =
                  String(value).length === 10 ? numeric * 1000 : numeric;
                value = new Date(millis).toISOString().slice(0, 10);
              }
              return `"${String(value).replace(/"/g, '""')}"`;
            })
            .join(",");
          rows.push(row);
        }

        return rows.join("\n");
      }

      function triggerDownload(filename, content) {
        const blob = new Blob([content], { type: "text/csv" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      async function downloadPages() {
        const button = document.querySelector("button");

        try {
          button.disabled = true;
          showStatus("Fetching all content models...");

          // Fetch pages
          const pages = await fetchAllPages();
          showStatus(
            `Fetched ${pages.length} pages. Resolving responsible person references...`
          );

          const pagesWithPersons = await resolveResponsiblePersons(pages);

          // Fetch additional content models
          const contentModels = [
            "blog-posts",
            "job-details",
            "materials",
            "abfallschlussel-avv-model",
          ];
          const allContent = [...pagesWithPersons];

          for (const model of contentModels) {
            showStatus(`Fetching ${model} content...`);
            const modelContent = await getAllBuilderContentUrls(model);
            allContent.push(...modelContent);
            showStatus(
              `Fetched ${modelContent.length} ${model} items. Total: ${allContent.length} items.`
            );
          }

          showStatus("Converting to CSV...");
          const csv = convertToCSV(allContent);

          triggerDownload("builder-all-content.csv", csv);
          showStatus(
            `✅ Downloaded ${
              allContent.length
            } total items to CSV (pages + ${contentModels.join(", ")})`
          );

          // Hide status after 3 seconds
          setTimeout(() => {
            hideStatus();
          }, 3000);
        } catch (err) {
          console.error(err);
          showStatus(`❌ Error: ${err.message}`);
        } finally {
          button.disabled = false;
        }
      }
    </script>
  </body>
</html>
